<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>DetectEmotion</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <header>
        <div class="logo">DetectEmotion</div>
        <nav>
            <span class="user-email">{{ nombre_usuario }}</span>
            <a href="/admin/usuarios">Asignar</a>
            <a href="/">Inicio</a>
            <a href="/historial">Historial</a>
            <a href="/login">Cerrar Sesión</a>
        </nav>
    </header>

    <main>
        <div class="titulo">
            <h2>Bienvenido a DetectEmotion</h2>
        </div>

        <div class="upload-box">
            <form action="/subir" method="POST" enctype="multipart/form-data" onsubmit="return validarFormulario()">

                <input type="text" name="nombre" placeholder="Ingresar nombre / unicamente letras" required
                    class="input-nombre">
                <input type="number" name="edad" placeholder="Edad ejemplo: 1 - 18" required min="1" max="18"
                    class="input-nombre">

                <div class="file-upload-container">
                    <input type="file" name="archivo" id="archivo" accept="video/*,image/*" required />
                    <label for="archivo" class="file-upload-label">
                        Seleccionar archivo
                    </label>
                    <span id="file-name" class="file-name">Ningún archivo seleccionado</span>
                    <div id="file-confirm" class="file-confirm" style="display: none;">
                        Archivo listo para detectar
                    </div>
                </div>

                <button type="submit" class="submit">Detectar</button>
                <div id="mensajeDetectando" class="mensaje-detectando" style="display: none;">
                    Detectando emociones...
                </div>

            </form>

            {% if mensaje_error %}
            <div id="mensajeError" class="error-message">
                {{ mensaje_error }}
            </div>
            {% endif %}
        </div>
    </main>

    <!-- MODAL DE RESULTADO PARA VIDEO -->
    <div id="modalResultado" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" onclick="cerrarModal()">&times;</span>
            <h2>Resultado de la detección</h2>
            <div class="items-text">
                <p><strong>Nombre:</strong> <span id="video-nombre"></span>
                    <strong>Edad:</strong> <span id="video-edad"></span>
                </p>
            </div>

            <h3>Emociones detectadas en el video:</h3>
            <table>
                <thead>
                    <tr>
                        <th>Emoción</th>
                        <th>Inicio (s)</th>
                        <th>Fin (s)</th>
                    </tr>
                </thead>
                <tbody id="tablaResultados">
                    <!-- Insertado desde JS -->
                </tbody>
            </table>
            <p><strong>Tiempo proc:</strong> <span id="video-tiempo"></span>s
                <strong>Precisión:</strong> <span id="video-precision"></span>%
            </p>
            <form method="POST" action="/guardar">
                <input type="hidden" name="nombre" value="{{ nombre }}">
                <input type="hidden" name="edad" value="{{ edad }}">
                <input type="hidden" name="video_nombre" value="{{ video_nombre }}">
                <input type="hidden" name="emociones_json" id="emocionesJsonInput">
                <input type="hidden" name="inicio_det" value="{{ inicio_det }}">
                <input type="hidden" name="fin_det" value="{{ fin_det }}">
                <input type="hidden" name="tiempo_procesamiento" value="{{ tiempo_procesamiento }}">
                <input type="hidden" name="precision_global" value="{{ precision_global }}">
                <input type="hidden" name="precision_global" id="precisionGlobalInput">
                <button type="submit" class="btn-guardar">Guardar</button>
            </form>
            <button onclick="cerrarModal()" class="btn-subir">Cerrar</button>
        </div>
    </div>

    <!-- MODAL DE RESULTADO PARA IMAGEN -->
    <div id="modalResultadoImagen" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-btn" onclick="cerrarModalImagen()">&times;</span>
            <h2>Resultado de la detección</h2>

            <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap;">
                <center> <img id="imagenMostrada" src="" alt="Imagen detectada"
                        style="max-width:320px; border-radius:8px;"></center>


                <div>
                    <p><b>Nombre:</b> <span id="imgNombreTxt"></span></p>
                    <p><b>Edad:</b> <span id="imgEdadTxt"></span></p>
                    <p><b>Emoción detectada:</b> <span id="imgEmocionTxt"></span></p>
                    <p><b>Confianza:</b> <span id="imgConfianzaTxt"></span>%</p>
                    <p><b>Tiempo de análisis:</b> <span id="imgTiempoTxt"></span> s</p>


                    <!-- apunta al endpoint guardarimagen -->
                    <form method="POST" action="/guardar-imagen">
                        <input type="hidden" name="nombre" id="imgNombre">
                        <input type="hidden" name="edad" id="imgEdad">
                        <input type="hidden" name="imagen_path" id="imgPath">
                        <input type="hidden" name="emocion" id="imgEmocion">
                        <input type="hidden" name="confianza" id="imgConfianza">
                        <input type="hidden" name="tiempo_procesamiento" id="imgTiempo">
                        <button type="submit" class="btn-guardar">Guardar</button>
                    </form>
                </div>
            </div>

            <button onclick="cerrarModalImagen()" class="btn-subir">Cerrar</button>
        </div>
    </div>

    {% if resultado_imagen_json %}
    <script>
        function abrirModalImagen(r) {
            document.getElementById('imagenMostrada').src = r.imagen_url;
            document.getElementById('imgNombreTxt').textContent = r.nombre;
            document.getElementById('imgEdadTxt').textContent = r.edad;
            document.getElementById('imgEmocionTxt').textContent = r.emocion;
            document.getElementById('imgConfianzaTxt').textContent = r.confianza;
            document.getElementById('imgTiempoTxt').textContent = r.tiempo;

            // Hidden fields para guardar
            document.getElementById('imgNombre').value = r.nombre;
            document.getElementById('imgEdad').value = r.edad;
            document.getElementById('imgPath').value = r.imagen_guardada;
            document.getElementById('imgEmocion').value = r.emocion;
            document.getElementById('imgConfianza').value = r.confianza;
            document.getElementById('imgTiempo').value = r.tiempo;

            document.getElementById('modalResultadoImagen').style.display = 'block';
        }

        function cerrarModalImagen() {
            document.getElementById('modalResultadoImagen').style.display = 'none';
        }

        // Render al cargar
        window.addEventListener('load', () => {
            const r = JSON.parse('{{ resultado_imagen_json | safe}}');
            abrirModalImagen(r);
        });
    </script>
    {% endif %}

    <footer>
        <span>DetectEmotion</span>
        <span></span>
    </footer>

</body>

<script>
    const fileInput = document.getElementById('archivo');
    const fileNameSpan = document.getElementById('file-name');
    const fileConfirm = document.getElementById('file-confirm');
    const descText = document.getElementById('descText');

    fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (!file) {
            fileNameSpan.textContent = "Ningún archivo seleccionado";
            fileConfirm.style.display = "none";
            return;
        }

        fileNameSpan.textContent = file.name.length > 35
            ? file.name.substring(0, 35) + "..."
            : file.name;

        if (file.type.startsWith('image/')) {
            descText.textContent = 'Sube una imagen con el rostro en primer plano';
        } else if (file.type.startsWith('video/')) {
            descText.textContent = 'Sube un video para detectar la emoción a lo largo del tiempo';
        } else {
            descText.textContent = 'Formato no soportado';
        }

        fileConfirm.style.display = "block";
    });
</script>

<script>
    function cerrarModal() {
        document.getElementById("modalResultado").style.display = "none";
    }
</script>

<!-- SIEMPRE SE CARGA -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const nombreInput = document.querySelector('input[name="nombre"]');

        if (nombreInput) {
            nombreInput.addEventListener("keypress", function (e) {
                const char = String.fromCharCode(e.keyCode || e.which);
                if (!/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]$/.test(char)) {
                    e.preventDefault();
                }
            });
        }
    });

    function validarFormulario() {
        const nombreInput = document.querySelector('input[name="nombre"]');
        const nombre = nombreInput.value.trim();
        const mensaje = document.getElementById("mensajeDetectando");

        const soloLetras = /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]{3,30}$/;

        if (!soloLetras.test(nombre)) {
            alert("El nombre debe tener entre 3 y 30 letras, sin números ni símbolos.");
            nombreInput.value = "";
            nombreInput.focus();
            mensaje.style.display = "none";
            return false;
        }

        mensaje.style.display = "block";
        return true;
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const errorBox = document.getElementById("mensajeError");

        if (errorBox) {
            setTimeout(() => {
                errorBox.style.display = "none";
                errorBox.setAttribute("data-visible", "false");
            }, 5000);
        }
    });
</script>


{% if emociones_detectadas is defined and emociones_detectadas %}
<script>
    window.onload = function () {
        const resultados = JSON.parse('{{ emociones_detectadas | safe }}');
        const tabla = document.getElementById("tablaResultados");

        resultados.forEach(e => {
            const fila = document.createElement("tr");
            fila.innerHTML = `<td>${e.emocion}</td><td>${e.inicio}</td><td>${e.fin}</td>`;
            tabla.appendChild(fila);
        });

        document.getElementById("modalResultado").style.display = "block";
        document.getElementById("emocionesJsonInput").value = JSON.stringify(resultados);
    };
</script>
{% endif %}

{% if emociones_detectadas is defined and emociones_detectadas %}
<script>
    window.onload = function () {
        const resultados = JSON.parse('{{ emociones_detectadas | safe }}');
        const tabla = document.getElementById("tablaResultados");

        // ✅ Listar emociones en la tabla (esto ya lo tenías)
        resultados.forEach(e => {
            const fila = document.createElement("tr");
            fila.innerHTML = `<td>${e.emocion}</td><td>${e.inicio}</td><td>${e.fin}</td>`;
            tabla.appendChild(fila);
        });

        // ✅ NUEVO: mostrar nombre, edad, archivo y tiempo en el modal
        const nombre = "{{ nombre|default('') }}";
        const edad = "{{ edad|default('') }}";
        const tiempoProcesamiento = "{{ tiempo_procesamiento|default('') }}";
        const precisionGlobal = "{{ precision_global|default('') }}";

        document.getElementById("video-nombre").textContent = nombre;
        document.getElementById("video-edad").textContent = edad;
        document.getElementById("video-tiempo").textContent = tiempoProcesamiento;
        document.getElementById("video-precision").textContent = precisionGlobal;
        document.getElementById("precisionGlobalInput").value = precisionGlobal;

        document.getElementById("modalResultado").style.display = "block";
        document.getElementById("emocionesJsonInput").value = JSON.stringify(resultados);
    };
</script>
{% endif %}


</html>